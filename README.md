# DASICS CVE-2021-3156 防护

## 版本要求

`sudo`：1.8.31

`glibc`：2.31

`Linux`：4.18 或 5.10.167-gee203559bc0b-dirty

## 使用方法

为了方便，在编译 `Linux` 时，不能使用 `initramfs` 方式，而使用本仓库中提供的 `rootfs.img` 作为根目录启动，内部包含了支持 `sudo` 以及 `nss` 服务正常工作的必要配置文件，是一个极其简单的发行版。

利用 `DASICS_QEMU` 提供的 `qemu` 以 `rootfs.img` 为根目录启动 `bbl`。此外，也可以利用 `OpenSBI` 启动 `linux`。示例命令如下：

```shell
#!/bin/sh
qemu-system-riscv64 -M virt -m 1G \
        -cpu rv64 \
        -nographic \
        -kernel bbl \
        -drive file=rootfs.img,format=raw,id=hd0 \
        -device virtio-blk-device,drive=hd0 \
        -append "console=ttyS0 rw root=/dev/vda" \
        -bios none  -s
```

进入 `busybox` 命令行界面后执行如下命令：

```shell
$ su wanghan
$ cd
$ whoami
$ ./expolit
$ whoami
```

由于系统启动进入命令行界面后便是 `root` 权限，此时可以使用 `passwd` 轻松修改密码。

## 防护原理

为了展示 `DASICS` 防护机制的作用，我们将该 `CVE` 中的风险函数 `set_cmnd` 函数放置到活跃区中，并将其中的`malloc` 和 `calloc` 函数使用 `DASICS` 主函数调用机制进行包装。这样便在主函数调用当中对分配的堆进行保护。

##  效果演示

<img src="image/image-20240101202711236.png" alt="image-20240101202711236" style="zoom:50%;" />

可见，当我们执行 `./expolit` 之后，`set_cmnd` 分配 `0x8071ce0~0x8071dc2` 的堆空间来拷贝命令行参数，当其尝试越界写该堆区以外的空间时，便按预期触发了 `DASICS` 越界写用户态中断（如第一条用户态中断信息，其越界地址为 `0x8071dc3`）。`DASICS` 防护机制成功的发挥了作用。

另一方面，该 `CVE` 通过错误的加载非可信的第三方库，使得动态链接器在执行该库的初始化函数时执行非可信的代码从而造成攻击，在 `DASICS` 保护进制中，对非可信区的系统调用进行拦截，可以有效防御该类攻击。
