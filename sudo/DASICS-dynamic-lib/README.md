# `DASICS` 动态链接软件支持框架介绍

The English version of the README is [here](#README_ENG.md)

## 项目介绍

本项目是 `DASICS(Dynamic in-Address-Space Isolation by Code Segments)` 安全处理器设计方案的动态链接程序的软件支持框架。体系结构平台基于 `RISC-V`，支持 `DASICS` 动态链接程序的 `Linux` 在[这里](#https://github.com/DASICS-ICT/riscv-linux/tree/dasics_dynamic)。

## 目录介绍

### 编译结果目录

- `build`：生成的二进制文件的存放位置

### `DASICS` 文件目录 

- `dasics`：包括 `DASICS`  静态链接中所使用的一些 `API`
- `dasics_dll`：`DASICS` 中动态链接支持的主要功能文件
- `ecall`：`DASICS` 系统调用截取相关
- `memory`：`DASICS` 自管理堆区相关
- `main_lib`：静态链接到目标文件中的一些文件，目前只有一个 `my_printf` 
- `include`：通用头文件
- `start`：`DASICS` 动态链接程序启动的关键文件

### 用户程序实现

- `test`：用户在这里开始编写自己的 C 文件实现，此处存在用户的主函数入口 `main`
- `test_lib`：用户在这里编写自己的第三方库
- `test_lib_header`：用户自己编写的第三方库的头文件

## 使用方法

### 在 `test` 目录下编写自己的程序

例如当前在 test 目录下存在一个 `main.c` 文件，如果还有其他的位置还有代码文件，需要添加到 `Makefile` 文件中的 `SRC_TEST` 当中。

```Makefile
SRC_TEST   			= $(wildcard ./test/*.c)
```

### 编写头文件

- 直接在 test 目录下编写头文件

- 在其他的目录编写头文件，并将路径加入到 Makefile 文件中的 `CFLAGS` 中

```makefile
CFLAGS = -O2 -g -Iinclude -Itest_lib_header -Idasics_dll/include -Imemory/include -Iecall/include -w
```

### 使用交叉编译工具链

- 在 `Makefile` 中指定交叉编译工具链路径

```makefile
CROSS_COMPILE = riscv64-unknown-linux-gnu-
```

### 编译

在当前目录执行 `make`，便可在 build 目录中得到目标 `ELF` 文件

```bash
$ make
```

### 运行

启动 `DAISCS` 提供的 `Linux` 后，在终端中以命令行参数的形式启动程序。

```bash
$./hello -dasics
```

对于打开了 `DASICS` 保护的动态链接程序，必须在启动程序时添加 `-dasics` 命令行参数选项。否则内核不会启动 `DASICS` 保护机制而是以普通程序的方式启动文件。

## 重要宏定义说明

- `DASICS_LINUX`：该宏定义会在编译程序时打开 `DASICS` 保护机制
- `DASICS_COPY`：该宏定义会在编译程序时加入可信库的非可信拷贝的初始化代码
- `DASICS_DEBUG`：该宏定义会打印出 `DASICS` 动态链接相关的调试信息

## 链接器脚本

为了实现  `DASICS` 的动态链接支持，我们使用了修改后的链接器脚本 `ld.lds` 。其位于当前目录下。在用户使用时需要将相关的路径修改为自己的编译工具链的路径。

```
SEARCH_DIR("=/home/wh/riscv/riscv64-unknown-linux-gnu/riscv64-unknown-linux-gnu/lib64/lp64d"); SEARCH_DIR("=/home/wh/riscv/riscv64-unknown-linux-gnu/riscv64-unknown-linux-gnu/lib64"); SEARCH_DIR("=/usr/local/lib64/lp64d"); SEARCH_DIR("=/usr/local/lib64"); SEARCH_DIR("=/lib64/lp64d"); SEARCH_DIR("=/lib64"); SEARCH_DIR("=/usr/lib64/lp64d"); SEARCH_DIR("=/usr/lib64"); SEARCH_DIR("=/home/wh/riscv/riscv64-unknown-linux-gnu/riscv64-unknown-linux-gnu/lib"); SEARCH_DIR("=/usr/local/lib"); SEARCH_DIR("=/lib"); SEARCH_DIR("=/usr/lib");
```

