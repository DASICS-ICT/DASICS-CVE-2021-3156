# Introduction to the `DASICS` Dynamic Linking Software Support Framework

## Project Introduction

This project is a software support framework for the dynamic linking program of the `DASICS (Dynamic in-Address-Space Isolation by Code Segments)` secure processor design solution. The architecture platform is based on `RISC-V`, and the `DASICS` dynamic linking program is supported in `Linux` available [here](#https://github.com/DASICS-ICT/riscv-linux/tree/dasics_dynamic).

## Directory Structure

### Build Directory

- `build`: Location for storing generated binary files

### `DASICS` File Directory

- `dasics`: Includes some APIs used in `DASICS` static linking
- `dasics_dll`: Main functional files for dynamic linking support in `DASICS`
- `ecall`: Related to `DASICS` system call interception
- `memory`: Related to self-managed heap area in `DASICS`
- `main_lib`: Some files statically linked into the target file, currently only contains `my_printf`
- `include`: Common header files
- `start`: Key file for the startup of `DASICS` dynamic linking program

### User Program Implementation

- `test`: This is where users start writing their own C files, including the main function entry `main`
- `test_lib`: Users write their own third-party libraries here
- `test_lib_header`: Header files for user-written third-party libraries

## Usage Instructions

### Writing Your Program in the `test` Directory

For example, if there is a `main.c` file in the current `test` directory, if there are other code files in different locations, they need to be added to the `SRC_TEST` variable in the `Makefile`.

```Makefile
SRC_TEST = $(wildcard ./test/*.c)
```

### Writing Header Files

- Write header files directly in the `test` directory.
- Write header files in other directories and add the paths to the `CFLAGS` variable in the `Makefile`.

```makefile
CFLAGS = -O2 -g -Iinclude -Itest_lib_header -Idasics_dll/include -Imemory/include -Iecall/include -w
```

### Using Cross-Compilation Toolchain

- Specify the cross-compilation toolchain path in the `Makefile`.

```makefile
CROSS_COMPILE = riscv64-unknown-linux-gnu-
```

### Compilation

Execute `make` in the current directory to obtain the target `ELF` file in the `build` directory.

```bash
$ make
```

### Execution

After booting the `Linux` provided by `DAISCS`, launch the program in the terminal with command-line parameters.

```bash
$ ./hello -dasics
```

For dynamic linking programs protected by `DASICS`, the `-dasics` command-line option must be added when starting the program. Otherwise, the kernel will launch the file as a regular program without activating the `DASICS` protection mechanism.

## Important Macro Definitions

- `DASICS_LINUX`: This macro definition enables the `DASICS` protection mechanism during program compilation.
- `DASICS_COPY`: This macro definition adds the initialization code for non-trusted copies of trusted libraries during program compilation.
- `DASICS_DEBUG`: This macro definition enables the printing of debugging information related to `DASICS` dynamic linking.

## Linker Script

To support dynamic linking in `DASICS`, we use a modified linker script called `ld.lds`, which is located in the current directory. When users utilize it, they need to modify the relevant paths to match their own compilation toolchain.

```
SEARCH_DIR("=/path/to/your/toolchain/lib64/lp64d");
SEARCH_DIR("=/path/to/your/toolchain/lib64");
SEARCH_DIR("=/usr/local/lib64/lp64d");
SEARCH_DIR("=/usr/local/lib64");
SEARCH_DIR("=/lib64/lp64d");
SEARCH_DIR("=/lib64");
SEARCH_DIR("=/usr/lib64/lp64d");
SEARCH_DIR("=/usr/lib64");
SEARCH_DIR("=/path/to/your/toolchain/lib");
SEARCH_DIR("=/usr/local/lib");
SEARCH_DIR("=/lib");
SEARCH_DIR("=/usr/lib");
```

Please replace `/path/to/your/toolchain` with the actual path to your compilation toolchain.