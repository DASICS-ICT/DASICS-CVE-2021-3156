#include <utrap.h>
#include <my_stdio.h>

/*
 * This function is used to alloc a couple of bound register
 * from the regs_context_t.
 */
int32_t trap_libcfg_alloc(regs_context_t* regs, uint64_t cfg, uint64_t hi, uint64_t lo)
{
    int32_t step = 4;  // rv64
    cfg |= DASICS_LIBCFG_V;

    for (int idx = 0; idx < 16; idx++)
    {

        uint64_t *libcfg = &(regs->dasicsLibCfg);

        if (!(((*libcfg) >> (idx * step)) & DASICS_LIBCFG_V))
        {
            regs->dasicsLibBounds[2 * idx] = lo;
            regs->dasicsLibBounds[2 * idx + 1] = hi;
            (*libcfg) &= ~(0xffUL << (idx * step));
            (*libcfg) |= (cfg << (idx * step));
            return idx;
        }   
    }
    return -1;
}


int32_t trap_libcfg_free(regs_context_t* regs, int32_t idx)
{
    int32_t step = 4;  // rv64
    uint64_t *libcfg = &(regs->dasicsLibCfg);    

    regs->dasicsLibBounds[2 * idx] = 0;
    regs->dasicsLibBounds[2 * idx + 1] = 0;
    (*libcfg) &= ~(0xffUL << (idx * step));   
    
    return 0;
}

uint32_t trap_libcfg_get(regs_context_t* regs, int32_t idx)
{
    /* TODO : get the libcfg when trap */
}


int32_t trap_jumpcfg_alloc(regs_context_t* regs, uint64_t hi, uint64_t lo)
{
    int32_t step = 16;  // rv64  

    for (int idx = 0; idx < 4; idx++)
    {

        uint64_t *libcfg = &(regs->dasicsJumpCfg);

        if (!(((*libcfg) >> (idx * step)) & DASICS_JUMPCFG_V))
        {
            regs->dasicsJumpBounds[2 * idx] = lo;
            regs->dasicsJumpBounds[2 * idx + 1] = hi;
            (*libcfg) &= ~(DASICS_JUMPCFG_MASK << (idx * step));
            (*libcfg) |= (DASICS_JUMPCFG_V << (idx * step));
            return idx;
        }   
    }
    return -1;

}


int32_t trap_jumpcfg_free(regs_context_t* regs, int32_t idx)
{
    int32_t step = 16;  // rv64
    uint64_t *libcfg = &(regs->dasicsJumpCfg);    

    regs->dasicsJumpBounds[2 * idx] = 0;
    regs->dasicsJumpBounds[2 * idx + 1] = 0;
    (*libcfg) &= ~(DASICS_JUMPCFG_MASK << (idx * step));   
    
    return 0;
}